<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Ä¢ BIOS PIN</title>
  <meta name="theme-color" content="#06110b" />
  <style>
    :root{
      --bg:#040806; --panel:#07130c; --panel2:#050c08;
      --neon:#16ff6a; --neon2:#00d4ff; --gold:#ffcc33;
      --text:#d7ffe5; --muted:#84caa0;
      --danger:#ff4d4d;
      --radius:18px;
      --shadow: 0 0 0 1px rgba(22,255,106,.18), 0 18px 50px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 30% -10%, rgba(22,255,106,.10), transparent 60%),
                  radial-gradient(1000px 700px at 120% 10%, rgba(255,204,51,.10), transparent 55%),
                  linear-gradient(180deg, #020402, #040806);
      color:var(--text);
      min-height:100svh;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .wrap{width:min(720px, 100%);}
    .top{
      display:flex; align-items:center; gap:12px; margin-bottom:14px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(180deg, rgba(22,255,106,.18), rgba(0,0,0,.2));
      box-shadow: 0 0 0 1px rgba(22,255,106,.25), 0 18px 40px rgba(0,0,0,.55);
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
      color:var(--neon);
    }
    h1{font-size:22px; margin:0; line-height:1.1}
    .sub{color:var(--muted); font-size:13px; margin-top:4px}
    .card{
      background: linear-gradient(180deg, rgba(7,19,12,.92), rgba(5,12,8,.92));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      border:1px solid rgba(22,255,106,.18);
      position:relative;
      overflow:hidden;
    }
    .scanline:before{
      content:"";
      position:absolute; inset:-200px -200px;
      background: repeating-linear-gradient(
        180deg,
        rgba(22,255,106,.06) 0px,
        rgba(22,255,106,.06) 1px,
        transparent 2px,
        transparent 6px
      );
      transform: rotate(0.2deg);
      pointer-events:none;
      opacity:.28;
      mix-blend-mode: screen;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .box{
      flex:1 1 260px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(22,255,106,.14);
      border-radius: 16px;
      padding:14px;
    }
    .title{font-weight:800; color:var(--neon); margin:0 0 8px; font-size:14px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(22,255,106,.18);
      background: rgba(0,0,0,.35);
      color:var(--text);
      outline:none;
      font-size:16px;
    }
    input:focus{box-shadow:0 0 0 3px rgba(22,255,106,.14)}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(22,255,106,.22);
      background: rgba(0,0,0,.32);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      min-width:140px;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(22,255,106,.18), rgba(0,0,0,.30));
      border-color: rgba(22,255,106,.35);
      color: var(--neon);
    }
    button.gold{
      background: linear-gradient(180deg, rgba(255,204,51,.18), rgba(0,0,0,.30));
      border-color: rgba(255,204,51,.35);
      color: var(--gold);
    }
    button.danger{
      border-color: rgba(255,77,77,.35);
      color: #ffb3b3;
    }
    button:disabled{opacity:.45; cursor:not-allowed}
    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(22,255,106,.14);
      background: rgba(0,0,0,.25);
      font-size:13px;
      color: var(--muted);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .pill{
      padding:6px 10px; border-radius: 999px;
      border:1px solid rgba(22,255,106,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size:12px;
    }
    .warn{color:#ffd27a}
    .bad{color:#ffb3b3}
    .ok{color:#b9ffd6}
    .foot{
      margin-top:12px;
      font-size:12px;
      color: rgba(215,255,229,.75);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    a{color:var(--neon2); text-decoration:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
<script src="system/guide/loader.js" defer></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">SC</div>
      <div>
        <h1>SerCucTech ‚Ä¢ BIOS PIN</h1>
        <div class="sub">Blocco Master ‚Äî anti-hacker (PIN hash + blocco tentativi + legame dispositivo)</div>
      </div>
    </div>

    <div class="card scanline">
      <div class="row">
        <div class="box">
          <p class="title">üîê Setup / Sblocco</p>

          <label>PIN (min 6 cifre/char)</label>
          <input id="pin" type="password" inputmode="numeric" autocomplete="off" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

          <div class="btns">
            <button id="btnUnlock" class="primary">Sblocca</button>
            <button id="btnSet" class="gold">Crea PIN</button>
          </div>

          <div class="status">
            <div>Stato: <span id="state" class="mono">‚Ä¶</span></div>
            <div class="pill">Device: <span id="dev" class="mono">‚Ä¶</span></div>
          </div>
        </div>

        <div class="box">
          <p class="title">‚ôªÔ∏è Cambio PIN (richiede sblocco)</p>

          <label>Nuovo PIN</label>
          <input id="newpin" type="password" inputmode="numeric" autocomplete="off" placeholder="nuovo PIN" />

          <label>Conferma nuovo PIN</label>
          <input id="newpin2" type="password" inputmode="numeric" autocomplete="off" placeholder="ripeti nuovo PIN" />

          <div class="btns">
            <button id="btnChange" class="primary" disabled>Cambia PIN</button>
            <button id="btnWipe" class="danger">Reset totale</button>
          </div>

          <div class="status">
            <div>Tentativi: <span id="tries" class="mono">0</span></div>
            <div>Blocco: <span id="lock" class="mono">no</span></div>
          </div>
        </div>
      </div>

      <div class="foot">
        <div>¬© SerCucTech Mini-PC Cloud Server</div>
        <div><a href="/" class="mono">‚Üê Torna al Control Center</a></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== Storage Keys (non contiene MAI il PIN in chiaro) ======
  const K = {
    salt: "sercuctech.pin.salt.v1",
    hash: "sercuctech.pin.hash.v1",
    dev:  "sercuctech.pin.device.v1",
    fail: "sercuctech.pin.fail.v1",
    lock: "sercuctech.pin.lockuntil.v1",
    ok:   "sercuctech.pin.unlocked.v1"
  };

  const $ = (id) => document.getElementById(id);
  const state = $("state"), dev = $("dev"), tries = $("tries"), lock = $("lock");
  const btnUnlock = $("btnUnlock"), btnSet = $("btnSet"), btnChange = $("btnChange"), btnWipe = $("btnWipe");

  function now() { return Date.now(); }
  function setText(el, txt, cls){
    el.textContent = txt;
    el.className = el.className.replace(/\b(ok|bad|warn)\b/g,"").trim();
    if (cls) el.classList.add(cls);
  }

  // ====== Device fingerprint (locale) ======
  async function deviceId() {
    const raw = [
      navigator.userAgent,
      navigator.language,
      screen.width + "x" + screen.height,
      Intl.DateTimeFormat().resolvedOptions().timeZone || "tz?"
    ].join("|");
    const h = await sha256(raw);
    return h.slice(0, 12);
  }

  // ====== Crypto helpers ======
  function b64u(bytes){
    let s = btoa(String.fromCharCode(...bytes));
    return s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }
  function b64uToBytes(s){
    s = s.replace(/-/g,"+").replace(/_/g,"/");
    while (s.length % 4) s += "=";
    const bin = atob(s);
    const out = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
    return out;
  }
  async function sha256(str){
    const buf = new TextEncoder().encode(str);
    const dig = await crypto.subtle.digest("SHA-256", buf);
    return [...new Uint8Array(dig)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }
  async function pbkdf2Hash(pin, saltBytes, iterations=220000){
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      new TextEncoder().encode(pin),
      "PBKDF2",
      false,
      ["deriveBits"]
    );
    const bits = await crypto.subtle.deriveBits(
      { name:"PBKDF2", hash:"SHA-256", salt:saltBytes, iterations },
      keyMaterial,
      256
    );
    return b64u(new Uint8Array(bits));
  }

  function pinOk(pin){ return typeof pin === "string" && pin.trim().length >= 6; }

  function getFail(){ return parseInt(localStorage.getItem(K.fail)||"0",10); }
  function setFail(n){ localStorage.setItem(K.fail, String(n)); tries.textContent = String(n); }
  function getLockUntil(){ return parseInt(localStorage.getItem(K.lock)||"0",10); }
  function setLockUntil(t){ localStorage.setItem(K.lock, String(t)); }
  function isLocked(){
    const until = getLockUntil();
    if (!until) return false;
    const left = until - now();
    return left > 0;
  }
  function lockMsForFails(f){
    // blocchi progressivi (anti brute-force)
    if (f <= 2) return 0;
    if (f <= 4) return 30_000;      // 30s
    if (f <= 6) return 2*60_000;    // 2m
    if (f <= 8) return 10*60_000;   // 10m
    return 60*60_000;               // 1h
  }

  async function refreshUi(){
    const did = await deviceId();
    dev.textContent = did;

    const hasPin = !!localStorage.getItem(K.hash);
    const locked = isLocked();
    const until = getLockUntil();

    tries.textContent = String(getFail());
    lock.textContent = locked ? ("SI ("+Math.ceil((until-now())/1000)+"s)") : "no";

    if (!hasPin){
      setText(state, "Nessun PIN master impostato. Premi ‚ÄúCrea PIN‚Äù.", "warn");
      btnSet.disabled = false;
      btnUnlock.disabled = true;
      btnChange.disabled = true;
      return;
    }

    // se PIN esiste, verifica device binding
    const bound = localStorage.getItem(K.dev);
    if (bound && bound !== did){
      setText(state, "PIN presente, ma questo dispositivo NON √® autorizzato (device diverso).", "bad");
      btnUnlock.disabled = true;
      btnSet.disabled = true;
      btnChange.disabled = true;
      return;
    }

    btnSet.disabled = true;

    if (locked){
      setText(state, "Bloccato temporaneamente per troppi tentativi. Attendi‚Ä¶", "bad");
      btnUnlock.disabled = true;
      btnChange.disabled = true;
      return;
    }

    const unlocked = localStorage.getItem(K.ok) === "1";
    if (unlocked){
      setText(state, "Sbloccato ‚úÖ (puoi cambiare PIN).", "ok");
      btnUnlock.disabled = false;
      btnChange.disabled = false;
    } else {
      setText(state, "PIN master pronto. Premi ‚ÄúSblocca‚Äù.", "ok");
      btnUnlock.disabled = false;
      btnChange.disabled = true;
    }
  }

  async function createPin(){
    const pin = $("pin").value;
    if (!pinOk(pin)) return alert("PIN troppo corto. Minimo 6 caratteri.");

    const did = await deviceId();

    // salt random
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const hash = await pbkdf2Hash(pin, salt);

    localStorage.setItem(K.salt, b64u(salt));
    localStorage.setItem(K.hash, hash);
    localStorage.setItem(K.dev, did);   // lega al dispositivo
    localStorage.setItem(K.ok, "1");    // appena creato √® sbloccato
    setFail(0);
    setLockUntil(0);

    $("pin").value = "";
    await refreshUi();
    alert("‚úÖ PIN Master creato e legato a questo dispositivo.");
  }

  async function unlock(){
    if (isLocked()) return;

    const pin = $("pin").value;
    if (!pinOk(pin)) return alert("Inserisci il PIN (min 6).");

    const saltB64 = localStorage.getItem(K.salt);
    const goodHash = localStorage.getItem(K.hash);
    if (!saltB64 || !goodHash) return alert("Nessun PIN impostato.");

    const did = await deviceId();
    const bound = localStorage.getItem(K.dev);
    if (bound && bound !== did){
      return alert("Questo dispositivo non √® autorizzato.");
    }

    const salt = b64uToBytes(saltB64);
    const testHash = await pbkdf2Hash(pin, salt);

    if (testHash === goodHash){
      localStorage.setItem(K.ok, "1");
      setFail(0);
      setLockUntil(0);
      $("pin").value = "";
      await refreshUi();
      return alert("‚úÖ Sbloccato.");
    }

    // fail ‚Üí lock progressivo
    const f = getFail() + 1;
    setFail(f);
    const ms = lockMsForFails(f);
    if (ms > 0){
      setLockUntil(now() + ms);
    }
    localStorage.setItem(K.ok, "0");
    await refreshUi();
    alert("‚ùå PIN errato. Tentativi: " + f + (ms>0 ? (" ‚Äî Blocco " + Math.ceil(ms/1000)+"s") : ""));
  }

  async function changePin(){
    if (localStorage.getItem(K.ok) !== "1"){
      return alert("Prima devi sbloccare con il PIN attuale.");
    }
    const p1 = $("newpin").value;
    const p2 = $("newpin2").value;
    if (!pinOk(p1)) return alert("Nuovo PIN troppo corto (min 6).");
    if (p1 !== p2) return alert("Conferma PIN non coincide.");

    const did = await deviceId();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const hash = await pbkdf2Hash(p1, salt);

    localStorage.setItem(K.salt, b64u(salt));
    localStorage.setItem(K.hash, hash);
    localStorage.setItem(K.dev, did);
    localStorage.setItem(K.ok, "1");
    setFail(0);
    setLockUntil(0);

    $("newpin").value = "";
    $("newpin2").value = "";
    await refreshUi();
    alert("‚úÖ PIN cambiato.");
  }

  function wipe(){
    const ok = confirm("RESET TOTALE: cancella PIN, blocchi, autorizzazione device. Sei sicuro?");
    if (!ok) return;
    Object.values(K).forEach(k => localStorage.removeItem(k));
    $("pin").value = ""; $("newpin").value=""; $("newpin2").value="";
    refreshUi();
    alert("Reset fatto. Ora puoi creare un nuovo PIN.");
  }

  btnSet.addEventListener("click", createPin);
  btnUnlock.addEventListener("click", unlock);
  btnChange.addEventListener("click", changePin);
  btnWipe.addEventListener("click", wipe);

  // aggiorna lock countdown
  setInterval(refreshUi, 1000);
  refreshUi();
})();
</script>
  <script src="system/guide/doubletap.js" defer></script>
</body>
</html>
